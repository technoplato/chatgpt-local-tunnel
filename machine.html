<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XState Counter with WebSocket Inspector</title>
    <script type="module">
        import { createMachine, createActor, assign } from 'https://cdn.jsdelivr.net/npm/xstate@5.14.0/+esm';

        // Counter machine definition
        const counterMachine = createMachine({
            id: 'counter',
            initial: 'active',
            context: { count: 0 },
            states: {
                active: {
                    on: {
                        INCREMENT: {
                            actions: assign({ count: ({ context }) => context.count + 1 })
                        },
                        DECREMENT: {
                            actions: assign({ count: ({ context }) => context.count - 1 })
                        }
                    }
                }
            }
        });

        // WebSocket receiver for the inspector
        function createWebSocketReceiver(options = {}) {
            const resolvedOptions = {
                server: 'wss://everydaywetunnelin.ngrok.io',
                ...options
            };

            const ws = new WebSocket(resolvedOptions.server);

            ws.onopen = () => {
                console.log('WebSocket connected to inspector');
            };

            ws.onmessage = (event) => {
                if (typeof event.data !== 'string') {
                    return;
                }
                console.log('Received from inspector:', JSON.parse(event.data));
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected from inspector');
            };

            return {
                send: (event) => {
                   console.log('Sending event to inspector:', event);
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify(event));
                    }
                }
            };
        }

        // Create the WebSocket receiver
        const receiver = createWebSocketReceiver();

        // Create the actor with the receiver as the inspector
        const counterActor = createActor(counterMachine, {
            inspect: (inspectionEvent) => {
                receiver.send(inspectionEvent);
            }
        }).start();

        // UI update function
        function updateUI() {
            const countElement = document.getElementById('count');
            countElement.textContent = counterActor.getSnapshot().context.count;
        }

        // Event listeners for buttons
        window.increment = () => {
            counterActor.send({ type: 'INCREMENT' });
            updateUI();
        };

        window.decrement = () => {
            counterActor.send({ type: 'DECREMENT' });
            updateUI();
        };

        // Initial UI update
        window.onload = updateUI;
    </script>
</head>
<body>
    <h1>XState Counter with WebSocket Inspector</h1>
    <p>Count: <span id="count">0</span></p>
    <button onclick="increment()">Increment</button>
    <button onclick="decrement()">Decrement</button>
</body>
</html>
