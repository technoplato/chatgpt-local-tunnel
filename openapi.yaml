openapi: 3.1.0
info:
  title: GPT Custom Server API
  version: 1.0.0
  description: This API allows a custom GPT instance to interact with files and run Jest tests programmatically.
servers:
  - url: https://everydaywetunnelin.ngrok.io
    description: ngrok public URL
    variables:
      subdomain:
        default: your_subdomain
paths:
  /machineState:
    get:
      summary: Get the current state of the machine with context
      operationId: getMachineState
      responses:
        "200":
          description: Machine state retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  state:
                    type: string
                    example: ""
                  context:
                    type: object
                    properties:
                      gptContextWindow:
                        type: string
                        example: "Some context window data that the gpt will use for help"
                      filesPaths:
                        type: array
                        items:
                          type: string
                        example:
                          - "/path/to/file1"
                          - "/path/to/file2"

  /machineSend:
    post:
      x-openai-isConsequential: false
      summary: Send a command to the GPT
      operationId: machineSend
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                command:
                  type: string
                  example: "gpt.understandsFileStructure"
      responses:
        '200':
          description: Command processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  state:
                    type: string
                    description: The state after processing the command
                  context:
                    type: object
                    description: The context associated with the state
                  hints:
                    type: object
                    description: Hints for GPT
                    properties:
                      hint1:
                        type: string
                        example: "Hint 1 description"
                      hint2:
                        type: string
                        example: "Hint 2 description"

  /files:
    post:
      operationId: postFiles
      summary: Upload and write files to specified paths
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                files:
                  type: array
                  items:
                    type: object
                    properties:
                      path:
                        type: string
                        description: Absolute path where the file will be written
                      content:
                        type: string
                        description: Content to be written to the file
      responses:
        '200':
          description: Files written successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Files written successfully
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Files are required and must be an array
        '500':
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

  /file:
    get:
      summary: Fetch the contents of the file
      operationId: getFileContents
      parameters:
        - in: query
          name: filePath
          required: true
          schema:
            type: string
          description: The path of the file to fetch
      responses:
        "200":
          description: File contents retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  content:
                    type: string
                    example: "test('simple test', () => { expect(true).toBe(false); });"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "File read error message"
    post:
      x-openai-isConsequential: false
      summary: Send the file with changes, apply changes locally, run Jest tests, and return the test results
      operationId: postFileChanges
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                filePath:
                  type: string
                  example: "example.spec.js"
                content:
                  type: string
                  example: "test('simple test', () => { expect(true).toBe(true); });"
      responses:
        "200":
          description: Test results
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: string
                    example: "PASS  ./example.spec.ts\n  simple test\n    ✓ simple test (2 ms)"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Test run error message"
  /all-files:
    get:
      summary: Return all the files in the project along with their directory structure.
      operationId: getAllFiles
      parameters:
        - in: query
          name: directory
          schema:
            type: string
          description: The directory to list the files from
      responses:
        "200":
          description: Command output retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  files:
                    type: object
                    properties:
                      allFileContents:
                        type: string
                        example: "Directory structure:\n\n├── Dockerfile\n├── docker-compose.yaml\n..."
                      fileTree:
                        type: string
                        example: "├── Dockerfile\n├── docker-compose.yaml\n..."
        "500":
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Command execution error message"
  /all-tests:
    get:
      summary: Run all Jest tests and return the output
      operationId: runAllTests
      responses:
        "200":
          description: Test output retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: string
                    example: "PASS  ./example.spec.js\n  simple test\n    ✓ simple test (2 ms)"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Test run error message"
  /propose-changes:
    post:
      x-openai-isConsequential: false
      summary: Commit file changes with a commit message, run tests, and return the results. Specify file paths relative to the project root.
      operationId: proposeChanges
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                commitMessage:
                  type: string
                  example: "Updated test case to expect true"
                files:
                  type: array
                  items:
                    type: object
                    properties:
                      filePath:
                        type: string
                        description: "Path relative to the project root"
                        example: "example.spec.js"
                      content:
                        type: string
                        example: "test('simple test', () => { expect(true).toBe(true); });"
      responses:
        "200":
          description: Test results
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: string
                    example: "PASS  ./example.spec.js\n  simple test\n    ✓ simple test (2 ms)"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Commit and test run error message"
  /select-files:
    post:
      x-openai-isConsequential: false
      summary: Select a set of files to retrieve later. Used to limit amount of content returned to caller.
      operationId: selectFiles
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                files:
                  type: array
                  items:
                    type: string
                  example: ["Dockerfile", "server.js", "scripts/outputRepoContents.js"]
      responses:
        "200":
          description: Files selected successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Files selected successfully"
                  selectedFiles:
                    type: array
                    items:
                      type: string
                    example: ["Dockerfile", "server.js", "scripts/outputRepoContents.js"]
        "400":
          description: Invalid input
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Files should be an array"
  /selected-files:
    get:
      summary: Retrieve the contents of selected files
      operationId: getSelectedFiles
      responses:
        "200":
          description: Selected files contents retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  allFileContents:
                    type: string
                    example: "Contents of selected files:\n\n### Dockerfile ###\n\n...file content...\n\n### server.js ###\n\n...file content...\n\n### scripts/outputRepoContents.js ###\n\n...file content...\n\n"
        "400":
          description: No files selected
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "No files selected"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "File read error message"
  /run-command:
    post:
      x-openai-isConsequential: false
      summary: Run an arbitrary shell command and commit changes
      operationId: runCommand
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                command:
                  type: string
                  example: "npm install xstate"
                commitMessage:
                  type: string
                  example: "Installed xstate package"
      responses:
        "200":
          description: Command executed and changes committed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Command executed and changes committed successfully"
                  output:
                    type: string
                    example: "Output of the command"
        "400":
          description: Invalid input
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Command and commit message are required"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Error executing command or committing changes"
components:
  schemas: {}
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
security:
  - bearerAuth: []
